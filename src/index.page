Menu="Notifications:2a"
Title="Web Push Notification Agent"
Icon="bell"
Tag="bell"
---
<?php
require_once $docroot . '/plugins/web-push-notification/include/loader.php';

use WebPushNotification\Models\VAPID;

$isWpnEnabled = false;
$enabledAgent = agent_fullname(WPN_AGENT_NAME . ".sh", "enabled");
$disabledAgent = agent_fullname(WPN_AGENT_NAME . ".sh", "disabled");
$shade = "shade-" . ($display['theme'] ?? 'unk');
$vapid = new VAPID();

if (is_file($disabledAgent) && is_file($enabledAgent))
    unlink($enabledAgent);
else if (is_file($enabledAgent))
    $isWpnEnabled = true;
?>
<style>
    #wpn-permission-status[data-status='green'] {
        color: green;
    }

    #wpn-permission-status[data-status='red'] {
        color: red;
    }

    #wpn-permission-status[data-status='orange'] {
        color: orange;
    }

    #wpn-device-list {
        margin: 10px 0 0 0;
        padding: 0;
        display: none;
    }

    #wpn-device-list>table {
        margin: 0;
    }

    #wpn-list-btn .hide,
    #wpn-list-btn.active .show {
        display: none;
    }

    #wpn-list-btn.active .hide {
        display: inline-block;
    }

    #wpn-list-btn>span {
        pointer-events: none;
    }

    #wpn-error {
        display: none;
    }

    #wpn-error-text {
        margin-left: 0;
        flex: 1;
        color: #ff0000;
        overflow: auto;
    }

    div.shade-white {
        background-color: #ededed;
        margin-top: 10px;
        padding: 8px 0 3px 0
    }

    div.shade-black {
        background-color: #212121;
        margin-top: 10px;
        padding: 8px 0 3px 0
    }

    div.shade-azure {
        background-color: #edeaef;
        margin-top: 10px;
        padding: 8px 0 3px 0
    }

    div.shade-gray {
        background-color: #121510;
        margin-top: 10px;
        padding: 8px 0 3px 0
    }
</style>
<dl>
    <dt><?php echo _("Agent function"); ?>:</dt>
    <dd>
        <select id="wpn-enable-select">
            <?php echo mk_option(!$isWpnEnabled, '0', _('Disabled')); ?>
            <?php echo mk_option($isWpnEnabled, '1', _('Enabled')); ?>
        </select>
    </dd>
</dl>
<dl>
    <dt>&nbsp;</dt>
    <dd>
        <button id="wpn-apply-btn" disabled><?php echo _('Apply'); ?></button>
        <button id="wpn-test-btn" <?php echo $vapid->getPrivateKey() && $vapid->getPublicKey() && $isWpnEnabled ? '' : 'disabled'; ?>><?php echo _('Test'); ?></button>
        <button id="wpn-list-btn" <?php echo $isWpnEnabled ? '' : 'disabled'; ?>><span class="show"><?php wpm_e('Show registered devices'); ?></span><span class="hide"><?php wpm_e('Hide registered devices'); ?></span></button>
    </dd>
</dl>
<div id="wpn-device-list"></div>
<div class="<?php echo $shade; ?>">
    <dl>
        <dt><?php wpm_e('VAPID public key:'); ?></dt>
        <dd><input id="wpn-publicKey" type="text" placeholder="<?php wpm_e('Must be generated'); ?>" value="<?php echo $vapid->getPublicKey(); ?>" disabled></dd>
    </dl>
    <blockquote class="inline_help">
        <?php wpm_e('Key needed to encrypt and send notification to push notification service.'); ?>
    </blockquote>
    <dl>
        <dt><?php wpm_e('VAPID private key:'); ?></dt>
        <dd><input id="wpn-privateKey" type="text" placeholder="<?php wpm_e('Must be generated'); ?>" value="<?php echo $vapid->getPrivateKey(); ?>" disabled></dd>
    </dl>
    <blockquote class="inline_help">
        <?php wpm_e('Key needed to authenticate your message and send notification to push notification service.'); ?>
    </blockquote>
    <dl>
        <dt>&nbsp;</dt>
        <dd>
            <button id="wpn-generate-vapid-btn" <?php echo $isWpnEnabled ? '' : 'disabled'; ?>><?php wpm_e('Generate VAPID keys'); ?></button>
            <?php wpm_e('Generating a new VAPID will revoke registered devices. You will need to register them again.'); ?>
        </dd>
    </dl>
</div>
<div class="<?php echo $shade; ?>">
    <dl>
        <dt><?php wpm_e('Permission:'); ?></dt>
        <dd>
            <span id="wpn-permission-status"><?php wpm_e('Request Permission and Register to push notification.'); ?></span>
        </dd>
    </dl>
    <blockquote class="inline_help">
        <?php wpm_e('Click the button below to request permission and register to push notification. You need to browse this page with each devices you want to use push notification and click on the button below.'); ?>
    </blockquote>
    <dl id="wpn-error">
        <dt><?php wpm_e('Error:'); ?></dt>
        <dd id="wpn-error-text"></dd>
    </dl>
    <dl>
        <dt>&nbsp;</dt>
        <dd><button id="wpn-permission-btn" <?php echo $vapid->getPrivateKey() && $isWpnEnabled ? '' : ' disabled'; ?>><?php wpm_e('Request permission and Register'); ?></button></dd>
    </dl>
</div>
<script>
var wpm_lng = <?php echo json_encode($wpm_lang) ?: []; ?>
</script>
<script src="/plugins/web-push-notification/assets/js/index.js"></script>
